"""
Dataset Visualization Script
============================

This script visualizes the annotations generated by synth_text_dataset.py.

It reads the annotation data (either from a single JSONL file or 
individual .json files) and draws the text labels and bounding polygons 
over the corresponding images.

The visualizations are saved to a specified output directory.

Example Usage:
----------------
# Default (assumes ./out/images, ./out/annotations_train.jsonl)
python visualize_dataset.py

# Specify data directory and number of images
python visualize_dataset.py --data_dir ./my_dataset --num_vis 100

# Specify a different JSONL filename
python visualize_dataset.py --data_dir ./out --jsonl_name annotations_val.jsonl
"""

import json
import os
import random
import cv2
import numpy as np
from pathlib import Path
from tqdm import tqdm
import argparse


def parse_args():
    """
    Parse command-line arguments for the visualization script.
    """
    parser = argparse.ArgumentParser(description="Visualize SynthText dataset annotations.")
    
    parser.add_argument('--data_dir', type=str, default='./out',
                        help='Root directory of the generated dataset (default: ./out)')
    
    parser.add_argument('--img_subdir', type=str, default='images',
                        help='Subdirectory name for images (default: images)')
    
    parser.add_argument('--label_subdir', type=str, default='labels',
                        help='Subdirectory name for individual JSON labels (default: labels)')
    
    parser.add_argument('--vis_subdir', type=str, default='visualize',
                        help='Subdirectory name to save visualizations (default: visualize)')
    
    parser.add_argument('--jsonl_name', type=str, default='annotations_train.jsonl',
                        help='Filename of the JSONL annotation file, relative to data_dir (default: annotations_train.jsonl)')
    
    parser.add_argument('--num_vis', type=int, default=50,
                        help='Number of images to visualize (default: 50)')
    
    return parser.parse_args()


def draw_instance(image, instance, color=(0, 255, 0)):
    """
    Draw a single text instance (polygon and text label) on the image.
    
    Args:
        image (np.ndarray): The image canvas (BGR).
        instance (dict): A single instance annotation.
        color (tuple): The BGR color for the polygon.
    """
    
    # 1. Draw polygon
    # The 'poly' field stores the polygon coordinates
    poly_pts = instance.get('poly')
    if not poly_pts:
        print(f"[Warn] Instance missing 'poly': {instance.get('text')}")
        return

    # Convert points to (N, 1, 2) integer array shape for cv2.polylines
    try:
        pts = np.array(poly_pts, dtype=np.int32).reshape((-1, 1, 2))
        cv2.polylines(image, [pts], isClosed=True, color=color, thickness=2)
    except Exception as e:
        print(f"[Error] Failed to draw polygon {poly_pts}: {e}")
        return
    
    # 2. Draw text label
    # The 'text' field stores the ground truth text
    text = instance.get('text', '')
    
    # 'bbox' field is used to find a good position for the label
    bbox = instance.get('bbox')
    if bbox:
        x1, y1 = int(bbox[0]), int(bbox[1])
        # Place text slightly above the top-left corner of the bbox
        text_pos = (x1, max(0, y1 - 10))
        
        # Draw a white outline for better visibility
        cv2.putText(image, text, text_pos, 
                    cv2.FONT_HERSHEY_SIMPLEX, 0.5, (255, 255, 255), 2)
        # Draw the main red text
        cv2.putText(image, text, text_pos, 
                    cv2.FONT_HERSHEY_SIMPLEX, 0.5, (0, 0, 255), 1)


def visualize_from_jsonl(jsonl_path, img_root, vis_dir, num_to_vis=50):
    """
    Read annotations from a JSONL file and visualize them.
    
    Args:
        jsonl_path (Path): Path to the .jsonl annotation file.
        img_root (Path): Path to the directory containing images.
        vis_dir (Path): Path to the directory to save visualizations.
        num_to_vis (int): Number of random samples to visualize.
    """
    print(f"Loading annotations from {jsonl_path}...")
    
    with open(jsonl_path, 'r', encoding='utf-8') as f:
        lines = f.readlines()
        
    # Randomly sample 'num_to_vis' lines for visualization
    sample_lines = random.sample(lines, min(len(lines), num_to_vis))
    
    for line in tqdm(sample_lines, desc="Visualizing (JSONL)"):
        try:
            ann = json.loads(line)
            image_id = ann['image_id']
            
            # Construct image path (assuming .jpg)
            img_path = img_root / f"{image_id}.jpg"
            if not img_path.exists():
                print(f"[Warn] Image not found: {img_path}")
                continue
                
            img = cv2.imread(str(img_path))
            
            # Iterate over all instances in this image
            for instance in ann.get('instances', []):
                draw_instance(img, instance)
                
            # Save the visualized image
            out_path = vis_dir / f"{image_id}_vis.jpg"
            cv2.imwrite(str(out_path), img)
            
        except json.JSONDecodeError:
            print(f"[Warn] Skipping invalid JSON line: {line[:50]}...")
        except Exception as e:
            print(f"[Error] Failed to process {image_id}: {e}")


def visualize_from_files(label_dir, img_root, vis_dir, num_to_vis=50):
    """
    Read annotations from individual JSON files and visualize them.
    
    Args:
        label_dir (Path): Path to the directory containing .json files.
        img_root (Path): Path to the directory containing images.
        vis_dir (Path): Path to the directory to save visualizations.
        num_to_vis (int): Number of random samples to visualize.
    """
    print(f"Loading annotations from {label_dir}...")
    json_files = sorted(list(label_dir.glob("*.json")))
    
    if not json_files:
        print(f"[Error] No .json files found in {label_dir}")
        return
        
    # Randomly sample 'num_to_vis' files
    sample_files = random.sample(json_files, min(len(json_files), num_to_vis))
    
    for json_path in tqdm(sample_files, desc="Visualizing (JSON files)"):
        try:
            with open(json_path, 'r', encoding='utf-8') as f:
                ann = json.load(f)
                
            image_id = ann['image_id']
            # Construct image path (assuming .jpg)
            img_path = img_root / f"{image_id}.jpg"
            if not img_path.exists():
                print(f"[Warn] Image not found: {img_path}")
                continue
                
            img = cv2.imread(str(img_path))
            
            # Iterate over all instances in this image
            for instance in ann.get('instances', []):
                draw_instance(img, instance)
                
            # Save the visualized image
            out_path = vis_dir / f"{image_id}_vis.jpg"
            cv2.imwrite(str(out_path), img)
            
        except Exception as e:
            print(f"[Error] Failed to process {json_path.name}: {e}")


def main():
    """
    Main execution function.
    """
    args = parse_args()
    
    # Construct paths from arguments
    DATA_DIR = Path(args.data_dir)
    IMG_ROOT = DATA_DIR / args.img_subdir
    LABEL_DIR = DATA_DIR / args.label_subdir
    VIS_DIR = DATA_DIR / args.vis_subdir
    JSONL_PATH = DATA_DIR / args.jsonl_name
    
    # Create the visualization directory if it doesn't exist
    VIS_DIR.mkdir(exist_ok=True)
    print(f"Saving visualizations to: {VIS_DIR}")
    
    # Auto-detect mode:
    # Prefer JSONL if it exists, otherwise fall back to individual files.
    if JSONL_PATH.exists():
        print("Found JSONL file, using JSONL mode.")
        visualize_from_jsonl(JSONL_PATH, IMG_ROOT, VIS_DIR, num_to_vis=args.num_vis)
    elif LABEL_DIR.exists() and any(LABEL_DIR.glob("*.json")):
        print("JSONL file not found, using individual .json file mode.")
        visualize_from_files(LABEL_DIR, IMG_ROOT, VIS_DIR, num_to_vis=args.num_vis)
    else:
        print(f"Error: Could not find annotations.")
        print(f"  Checked for JSONL at: {JSONL_PATH}")
        print(f"  Checked for JSON files in: {LABEL_DIR}")


if __name__ == "__main__":
    main()